<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scanner Management ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f4f6f8;
      color: #222;
    }

    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }

    .warning {
      background: #fff3cd;
      color: #856404;
      padding: 12px;
      border-radius: 12px;
      margin: 10px 0 18px;
      display: none;
      font-weight: 700;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin: 18px 0;
    }

    .stat-card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 86px;
      justify-content: center;
    }

    .stat-card span { font-size: 13px; color: #666; }
    .stat-card strong { font-size: 30px; font-weight: 800; line-height: 1; }

    .section {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      padding: 16px;
      margin-bottom: 18px;
      scroll-margin-top: 140px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }

    .section-header h2 { margin: 0; font-size: 20px; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

    .search-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 16px 0 20px;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 1;
      min-width: 240px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #fff;
    }

    .filter-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .chip {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      background: #fff;
      color: #374151;
      white-space: nowrap;
      user-select: none;
    }

    .chip.active {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }

    .chip.danger.active {
      background: #b91c1c;
      border-color: #b91c1c;
    }

    button {
      padding: 8px 12px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      font-size: 13px;
      font-weight: 700;
    }
    button.secondary { background: #9ca3af; }

    input[type="date"] {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      background: #fff;
    }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px; border-bottom: 1px solid #e5e7eb; white-space: nowrap; text-align: left; }
    thead { background: #f3f4f6; }

    .status-overdue { color: #b91c1c; font-weight: 800; }
    .status-long    { color: #b45309; font-weight: 800; }
    .status-ok      { color: #111827; font-weight: 700; }

    .take   { color: #15803d; font-weight: 800; }
    .return { color: #b91c1c; font-weight: 800; }

    .empty-row { color: #6b7280; text-align: center; padding: 18px 10px; }

    .footer { text-align: center; margin: 26px 0; }

    .hidden { display: none !important; }

    /* Taken card breakdown styling */
    .taken-breakdown {
      margin-top: 8px;
      font-size: 12px;
      color: #555;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .taken-breakdown strong {
      font-weight: 600;
      font-size: 13px;
      color: #111;
    }
    /* ===== ADMIN LAYOUT (STEP 1) ===== */
    .admin-layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: #111827;
      color: #fff;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    /* STEP 2 ‚Äî LOGO COLLAPSE FIX */
    .sidebar.collapsed img {
      width: 36px !important;
    }

    .sidebar.collapsed > div {
      padding: 6px !important;
    }

    /* === SIDEBAR COLLAPSE === */
    .sidebar {
      transition: width 0.25s ease;
    }
    
    /* Collapsed sidebar */
    .sidebar.collapsed {
      width: 72px;
    }
    
    /* STEP 4 ‚Äî FLOATING TOGGLE (EDGE BUTTON) */
    .sidebar {
      position: relative; /* REQUIRED */
    }
    
    .sidebar-toggle {
      position: absolute;
      top: 50%;
      right: -18px;              /* pushes button outside */
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #2563eb;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      z-index: 1000;
      pointer-events: auto;
    }
    
    /* Rotate arrow when collapsed ‚Äî KEEP CENTERED */
    .sidebar.collapsed .sidebar-toggle {
      transform: translateY(-50%) rotate(180deg);
    }
    
    /* STEP 3 ‚Äî COLLAPSE VISUALS */
    .sidebar.collapsed a {
      justify-content: center;
      padding: 12px 0;
    }

    .sidebar.collapsed .nav-text {
      display: none;
    }

    .sidebar.collapsed .nav-icon {
      font-size: 18px;
    }
    
    /* === HOVER GLOW FOR SIDEBAR TOGGLE === */
    .sidebar-toggle:hover {
      box-shadow:
        0 0 0 4px rgba(37, 99, 235, 0.35),
        0 6px 16px rgba(0, 0, 0, 0.35);
    }
    
    /* === SMOOTH SIDEBAR CONTENT ANIMATION === */
    .sidebar,
    .sidebar a,
    .sidebar img {
      transition:
        width 0.25s ease,
        opacity 0.2s ease,
        transform 0.2s ease;
    }
    
    /* Fade text when collapsing */
    .sidebar.collapsed .nav-text {
      opacity: 0;
      transform: translateX(-4px);
    }
    
    /* Slight icon emphasis */
    .sidebar .nav-icon {
      transition: transform 0.2s ease;
    }
    
    .sidebar.collapsed .nav-icon {
      transform: scale(1.1);
    }

    /* Sidebar links */
    .sidebar a {
      color: #e5e7eb;
      text-decoration: none;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* ============================= */
    /* üåô DARK MODE TOGGLE BUTTON */
    /* ============================= */
    
    .dark-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
      padding: 10px 14px;
      border-radius: 12px;
      background: #2563eb;
      color: #fff;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      border: none;
      width: 100%;
    }
    
    /* Hover polish */
    .dark-toggle:hover {
      background: #1d4ed8;
    }

    /* ============================= */
    /* üßä DARK MODE ‚Äî COLLAPSED FIX */
    /* ============================= */
    
    /* Sidebar collapsed ‚Üí icon only + centered */
    .sidebar.collapsed .dark-toggle {
      justify-content: center;
      padding: 10px 0;
    }
    
    /* Hide text only (keep icon visible) */
    .sidebar.collapsed .dark-toggle .dark-text {
      display: none;
    }

    /* ============================= */
    /* üßä COLLAPSED SIDEBAR BEHAVIOUR */
    /* ============================= */
    
    .sidebar.collapsed .dark-toggle {
      justify-content: center;   /* center icon */
      padding: 10px 0;
    }
    
    /* Hide text only (keep icon visible) */
    .sidebar.collapsed .dark-text {
      display: none;
    }
    
    /* Center icon when sidebar is collapsed */
    .sidebar.collapsed .dark-toggle {
      justify-content: center;
    }

    .sidebar a:hover {
      background: #1f2937;
    }

    /* Push Back-to-Home to bottom */
    .sidebar .spacer {
      flex: 1;
    }

    /* Main content area */
    .admin-content {
      flex: 1;
      background: #f4f6f8;
    }
    /* ===== SCROLLABLE TABLE WITH STICKY HEADERS ===== */
    .table-scroll {
      max-height: 420px;          /* adjust if you want */
      overflow-y: auto;
      border-radius: 12px;
    }

    .table-scroll thead th {
      position: sticky;
      top: 0;
      background: #f3f4f6;
      z-index: 3;
    }

    /* === TOOLTIP ONLY WHEN SIDEBAR COLLAPSED === */
    .sidebar:not(.collapsed) a[title] {
      pointer-events: auto;
    }
    
    /* Ensure proper hover target when collapsed */
    .sidebar.collapsed a {
      position: relative;
    }

    /* === USER DRILL-DOWN PANEL (SLIDE-IN DRAWER) === */
    .user-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 380px; /* ‚¨ÖÔ∏è wider like first image */
      height: 100vh;
      background: #ffffff;
      box-shadow: -10px 0 30px rgba(0,0,0,0.12); /* ‚¨ÖÔ∏è stronger shadow */
      border-radius: 16px 0 0 16px; /* ‚¨ÖÔ∏è rounded left edge */
      z-index: 1600;
      padding: 20px;
    
      display: flex;
      flex-direction: column;
    
      transform: translateX(100%);
      transition: transform 0.25s ease;
    }

    /* ‚úÖ FIX: SCROLLABLE USER PANEL BODY */
    .user-panel-body {
      flex: 1;                 /* take remaining height */
      overflow-y: auto;        /* enable vertical scroll */
      padding-right: 6px;      /* avoids scrollbar overlap */
    }

    .user-panel.hidden {
      transform: translateX(100%);
    }
    
    .user-panel:not(.hidden) {
      transform: translateX(0);
    }

    .user-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .user-panel-header h3 {
      margin: 0;
    }
    
    .user-panel-header button {
      background: #e5e7eb;       /* ‚¨ÖÔ∏è visible background */
      border: none;
      font-size: 16px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #111827;
    }
    
    .user-panel-header button:hover {
      background: #d1d5db;
    }

    .user-panel-body {
      margin-top: 6px;   /* ‚¨ÖÔ∏è reduce gap */
      font-size: 14px;
    }
    
    #userPanelSummary {
      margin: 4px 0 12px;   /* tight but readable */
      font-size: 14px;
      color: #374151;
    }
    
    .user-panel-body ul {
      padding-left: 18px;
    }

    .panel-box {
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px;
      margin-top: 16px;
    }
    
    .panel-box h4 {
      margin: 0 0 8px;
      font-size: 14px;
    }
    
    .panel-stats {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .panel-stats li {
      font-size: 13px;
      margin-bottom: 4px;
    }

    /* === USER PANEL: SCANNER CARD ROWS (STEP 2) === */

    #userPanelScanners {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .scanner-card-row {
      background: #f9fafb;
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .scanner-card-row .muted {
      color: #6b7280;
      margin-left: 6px;
    }
    
    .scanner-card-row .right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .scanner-card-row .hours {
      font-weight: 700;
    }

    /* === USER PANEL: QUICK STATS MINI CARDS (STEP 3) === */

    .panel-stat-card {
      background: #f3f4f6;
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 13px;
    }
    
    .panel-stat-card strong {
      font-size: 16px;
    }
    
    .panel-stat-card.danger {
      background: #fee2e2;
      color: #991b1b;
    }

    /* === USER PANEL: HEADER ALIGNMENT (STEP 4) === */

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-panel-header {
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 8px;
    }

    /* === USER PANEL OVERLAY === */
    .user-panel-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 1500;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }
    
    .user-panel-overlay:not(.hidden) {
      opacity: 1;
      pointer-events: auto;
    }

    /* === USER NAME CLICK UX (LIVE STATUS ONLY) === */
    .user-link {
      cursor: pointer;
      font-weight: 700;
      color: #2563eb;
    }
    
    .user-link:hover {
      text-decoration: underline;
    }

    .hint {
      font-size: 12px;
      color: #6b7280;
      margin: 4px 0 10px;
    }

    /* === MOBILE RESPONSIVE BEHAVIOUR === */
    @media (max-width: 768px) {
    
      /* User panel becomes full screen */
      .user-panel {
        width: 100vw;
        border-radius: 0;
      }
    
      /* Slightly larger close button for touch */
      .user-panel-header button {
        width: 40px;
        height: 40px;
        font-size: 18px;
      }
    
      /* Reduce padding so content fits better */
      .user-panel {
        padding: 16px;
      }
    
      /* Tables remain scrollable */
      .table-scroll {
        overflow-x: auto;
      }
      
      /* Keep dark mode button always tappable on mobile */
      .dark-toggle {
        position: sticky;
        bottom: 12px;
        z-index: 2000;
      }
    }

    /* === DARK MODE === */
    body.dark {
      background: #0f172a;
      color: #e5e7eb;
    }
    
    body.dark .section,
    body.dark .stat-card,
    body.dark .panel-box,
    body.dark .user-panel {
      background: #020617;
      color: #e5e7eb;
    }
    
    body.dark table thead {
      background: #020617;
    }
    
    body.dark th,
    body.dark td {
      border-color: #1e293b;
    }

    /* ============================= */
    /* üåô GLOBAL DARK MODE FOUNDATION */
    /* ============================= */
    
    body.dark {
      background: #0b0f1a;
      color: #e5e7eb;
    }
    
    /* Main app surface */
    body.dark .admin-content,
    body.dark .container {
      background: #0b0f1a;
    }
    
    /* Sidebar */
    body.dark .sidebar {
      background: #050814;
    }
    
    /* ============================= */
    /* üì¶ SECTIONS & CARDS */
    /* ============================= */
    
    body.dark .section,
    body.dark .stat-card,
    body.dark .panel-box,
    body.dark .table-scroll,
    body.dark .user-panel {
      background: #0f1629;
      box-shadow: none;
    }
    
    /* Card headers */
    body.dark .section-header h2,
    body.dark h3,
    body.dark h4 {
      color: #f9fafb;
    }
    
    /* ============================= */
    /* üìä TABLES */
    /* ============================= */
    
    body.dark table {
      color: #e5e7eb;
    }
    
    body.dark thead {
      background: #0b1224;
    }
    
    body.dark th {
      color: #9ca3af;
      border-bottom: 1px solid #1f2937;
    }
    
    body.dark td {
      border-bottom: 1px solid #1f2937;
    }
    
    body.dark tr:hover {
      background: rgba(255,255,255,0.04);
    }
    
    /* ============================= */
    /* üîç INPUTS / FILTERS */
    /* ============================= */
    
    body.dark .search-box,
    body.dark input[type="date"] {
      background: #050814;
      color: #e5e7eb;
      border: 1px solid #1f2937;
    }
    
    body.dark .search-box::placeholder {
      color: #6b7280;
    }
    
    body.dark .chip {
      background: #050814;
      border: 1px solid #1f2937;
      color: #e5e7eb;
    }
    
    body.dark .chip.active {
      background: #2563eb;
      border-color: #2563eb;
      color: #fff;
    }
    
    /* ============================= */
    /* üë§ USER DRILL-DOWN PANEL */
    /* ============================= */
    
    body.dark .user-panel {
      background: #0b1224;
    }
    
    body.dark .scanner-card-row {
      background: #050814;
    }
    
    /* ============================= */
    /* ‚ö†Ô∏è STATUS COLORS */
    /* ============================= */
    
    body.dark .status-ok {
      color: #22c55e;
    }
    
    body.dark .status-long {
      color: #f59e0b;
    }
    
    body.dark .status-overdue {
      color: #ef4444;
    }
    
    /* ============================= */
    /* üßæ LOG ACTIONS */
    /* ============================= */
    
    body.dark .take {
      color: #22c55e;
    }
    
    body.dark .return {
      color: #ef4444;
    }
    
    /* ============================= */
    /* üßº EMPTY STATES */
    /* ============================= */
    
    body.dark .empty-row,
    body.dark .hint {
      color: #9ca3af;
    }

    /* ============================= */
    /* üåô DARK MODE ‚Äî QUICK STATS FIX */
    /* ============================= */
    
    body.dark .panel-box {
      background: #0f1629;
      border: 1px solid rgba(255,255,255,0.06);
    }
    
    body.dark .panel-box h4 {
      color: #f9fafb;
    }
    
    body.dark .panel-stat-card {
      background: #050814;
      color: #e5e7eb;
      border: 1px solid rgba(255,255,255,0.06);
    }
    
    body.dark .panel-stat-card span {
      color: #9ca3af;
    }
    
    body.dark .panel-stat-card strong {
      color: #f8fafc;
    }
    
    /* Status card */
    body.dark .panel-stat-card.danger {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.35);
      color: #fecaca;
    }

    

  </style>
</head>

<body>
  <div class="admin-layout">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <!-- Sidebar Logo -->
        <div
          style="
            text-align: center;
            margin-bottom: 16px;
            background: #ffffff;
            padding: 10px;
            border-radius: 10px;
          "
        >
          <img
            src="assets/logo.png"
            alt="MFG Logo"
            style="width:120px; max-width:100%;"
          />
        </div>

      <a href="admin.html#dashboard" title="Dashboard">
        <span class="nav-icon">üìä</span>
        <span class="nav-text">Dashboard</span>
      </a>
      
      <a href="admin.html#status" title="Live Status">
        <span class="nav-icon">üì¶</span>
        <span class="nav-text">Live Status</span>
      </a>
      
      <a href="admin.html#logs" title="Logs">
        <span class="nav-icon">üßæ</span>
        <span class="nav-text">Logs</span>
      </a>
      
      <a href="admin.html#status-overdue" title="Overdue Scanners">
        <span class="nav-icon">üö®</span>
        <span class="nav-text">Overdue Scanners</span>
      </a>

      <div class="spacer"></div>

      <!-- üåô DARK MODE TOGGLE -->
      <button
        class="dark-toggle"
        onclick="toggleDarkMode()"
        title="Toggle dark mode"
      >
        <span id="darkIcon">üåô</span>
        <span class="dark-text">Dark Mode</span>
      </button>
      
      <!-- FLOATING COLLAPSE BUTTON -->
      <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar">
        ‚óÄ
      </button>
      
    </aside>

    <!-- MAIN CONTENT -->
    <main class="admin-content">

  <div class="container">

    <div id="warningBanner" class="warning">
      ‚ö†Ô∏è Overdue scanners detected. Immediate action required.
    </div>

    <!-- USER DRILL-DOWN PANEL (LIVE STATUS ONLY) -->
    <div id="userPanelOverlay" class="user-panel-overlay hidden"></div>

    <div id="userPanel" class="user-panel hidden">
      <div class="user-panel-header">
        <div class="header-left">
          <h3 id="userPanelName">User</h3>
          <span id="userPanelWarn" class="warn hidden">‚ö†Ô∏è</span>
        </div>
        <button onclick="closeUserPanel()">‚úï</button>
      </div>

      <div class="user-panel-body">
        <p id="userPanelSummary"></p>
    
        <h4>Currently held scanners</h4>
        <p class="hint">Showing active scanners only</p>
        
        <ul id="userPanelScanners"></ul>
        <!-- QUICK STATS -->
        <div class="panel-box">
          <h4>Quick stats</h4>
          <div class="panel-stat-card">
            <span>üìä Total scanners</span>
            <strong id="panelTotal">‚Äì</strong>
          </div>
          
          <div class="panel-stat-card">
            <span>‚è± Longest held</span>
            <strong id="panelLongest">‚Äì</strong>
          </div>
          
          <div class="panel-stat-card danger">
            <span>üî¥ Status</span>
            <strong id="panelStatus">‚Äì</strong>
          </div>
        </div>
        
        <!-- RECENT ACTIVITY -->
        <div class="panel-box">
          <h4>Recent activity</h4>
          <ul id="panelRecent"></ul>
        </div>
      </div>
    </div>

    <!-- DASHBOARD STATS -->
    <div class="stats" id="dashboard">
      <div class="stat-card"><span>Total Scanners</span><strong id="statTotal">‚Äì</strong></div>
      <div class="stat-card"><span>Available</span><strong id="statAvailable">‚Äì</strong></div>

      <div class="stat-card">
        <span>Taken</span>
        <strong id="statTaken">‚Äì</strong>
        <div class="taken-breakdown">
          <span>‚Ä¢ WMS <strong id="statTakenWMS">‚Äì</strong></span>
          <span>‚Ä¢ MUSHINY <strong id="statTakenMUSHINY">‚Äì</strong></span>
        </div>
      </div>

      <div class="stat-card"><span>Overdue</span><strong id="statOverdue">‚Äì</strong></div>
      <div class="stat-card"><span>Multi-Scanner Users</span><strong id="statMulti">‚Äì</strong></div>
    </div>

    <!-- DAILY SUMMARY -->
    <div class="section" id="dailySummary">
      <div class="section-header">
        <h2>Daily Summary (Today)</h2>
      </div>

      <div class="stats">
        <div class="stat-card">
          <span>Taken Today</span>
          <strong id="sumTaken">‚Äì</strong>
        </div>
        <div class="stat-card">
          <span>Returned Today</span>
          <strong id="sumReturned">‚Äì</strong>
        </div>
        <div class="stat-card">
          <span>Currently Overdue</span>
          <strong id="sumOverdue">‚Äì</strong>
        </div>
        <div class="stat-card">
          <span>Multi-Scanner Users</span>
          <strong id="sumMulti">‚Äì</strong>
        </div>
      </div>
    </div>

    <!-- FILTERS (IMPORTANT: id="filtersRow") -->
    <div class="search-row" id="filtersRow">
      <input
        id="searchInput"
        class="search-box"
        placeholder="Search by scanner or user"
      />

      <div class="filter-chips">
        <span class="chip" data-type="WMS">WMS</span>
        <span class="chip" data-type="MUSHINY">MUSHINY</span>
        <span class="chip danger" data-type="OVERDUE">Overdue</span>

        <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
          <input type="checkbox" id="autoRefreshToggle">
          Auto Refresh (30s)
        </label>
      </div>
    </div>

    <!-- TAKEN -->
    <div class="section" id="status">
      <div class="section-header">
        <h2>Currently Taken Scanners</h2>
        <div class="controls">
          <button class="secondary" onclick="exportStatusCSV()">Export CSV</button>
          <button onclick="loadStatus()">Refresh</button>
        </div>
      </div>

      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Scanner</th>
              <th>Type</th>
              <th>User</th>
              <th>Taken Since</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="statusTable">
            <tr><td class="empty-row" colspan="5">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- LOGS -->
    <div class="section" id="logs">
      <div class="section-header">
        <h2>Scanner Logs</h2>
        <div class="controls">
          <input type="date" id="fromDate">
          <input type="date" id="toDate">
          <button class="secondary" onclick="exportLogsCSV()">Export CSV</button>
          <button onclick="loadLogs()">Refresh</button>
        </div>
      </div>

      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Action</th>
              <th>Scanner</th>
              <th>Type</th>
              <th>User</th>
              <th>Date / Time</th>
            </tr>
          </thead>
          <tbody id="logsTable">
            <tr><td class="empty-row" colspan="5">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  <!-- FIREBASE (KEEP) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="config.js"></script>

  <script>
    const SOFT = 8;
    const HARD = 24;

    let statusRows = [];
    let logRows = [];
    let userScanCount = {};

    const elSearch = document.getElementById("searchInput");

    elSearch.addEventListener("input", () => {
      renderStatus();
      renderLogs();
    });

    let activeType = "ALL";
    let overdueOnly = false;

    // Chips click
    document.querySelectorAll(".chip").forEach(chip => {
      chip.addEventListener("click", () => {
        const type = chip.dataset.type;

        if (type === "OVERDUE") {
          overdueOnly = !overdueOnly;
          activeType = "ALL";
        } else {
          activeType = (activeType === type) ? "ALL" : type;
          overdueOnly = false;
        }

        document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));

        if (overdueOnly) {
          document.querySelector('.chip[data-type="OVERDUE"]').classList.add("active");
        } else if (activeType !== "ALL") {
          document.querySelector(`.chip[data-type="${activeType}"]`).classList.add("active");
        }

        renderStatus();
      });
    });

    // Auto refresh
    let autoRefreshTimer = null;
    const autoToggle = document.getElementById("autoRefreshToggle");

    autoToggle.addEventListener("change", () => {
      if (autoToggle.checked) {
        autoRefreshTimer = setInterval(() => {
          loadStatus();
          loadLogs();
        }, 30000);
      } else {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
      }
    });

    function hoursDiff(iso) {
      return (Date.now() - new Date(iso).getTime()) / 3600000;
    }

    async function loadStatus() {
      const db = firebase.database();
      document.getElementById("statusTable").innerHTML =
        `<tr><td class="empty-row" colspan="5">Loading‚Ä¶</td></tr>`;

      const [scannersSnap, takenSnap] = await Promise.all([
        db.ref("scanners").once("value"),
        db.ref("takenScanners").once("value"),
      ]);

      statusRows = [];
      userScanCount = {};

      let takenCount = 0;
      let overdueCount = 0;
      let takenWMS = 0;
      let takenMUSHINY = 0;

      takenSnap.forEach(typeSnap => {
        typeSnap.forEach(devSnap => {
          takenCount++;
          if (typeSnap.key === "WMS") takenWMS++;
          if (typeSnap.key === "MUSHINY") takenMUSHINY++;

          const v = devSnap.val() || {};
          const user = v.user || "UNKNOWN";
          userScanCount[user] = (userScanCount[user] || 0) + 1;

          const h = Math.floor(hoursDiff(v.time || new Date().toISOString()));

          let status = "OK";
          let cls = "status-ok";

          if (h >= HARD) {
            status = "Overdue";
            cls = "status-overdue";
            overdueCount++;
          } else if (h >= SOFT) {
            status = "Long";
            cls = "status-long";
          }

          statusRows.push({
            scanner: devSnap.key,
            type: typeSnap.key,
            user: v.user || "",
            hours: h,
            status,
            cls
          });
        });
      });

      const TOTAL_SCANNERS = 53;

      document.getElementById("statTotal").innerText = TOTAL_SCANNERS;
      document.getElementById("statTaken").innerText = takenCount;
      document.getElementById("statTakenWMS").innerText = takenWMS;
      document.getElementById("statTakenMUSHINY").innerText = takenMUSHINY;
      document.getElementById("statAvailable").innerText = TOTAL_SCANNERS - takenCount;
      document.getElementById("statOverdue").innerText = overdueCount;

      const multiUsers = Object.values(userScanCount).filter(c => c > 1).length;
      document.getElementById("statMulti").innerText = multiUsers;

      document.getElementById("warningBanner").style.display =
        overdueCount > 0 ? "block" : "none";

      renderStatus();
      loadDailySummary(); // keeps summary synced with latest counts
    }

    function renderStatus() {
      const q = (elSearch.value || "").toLowerCase().trim();
      const tb = document.getElementById("statusTable");
      tb.innerHTML = "";

      const filtered = statusRows
        .filter(r => {
          const matchesSearch =
            String(r.scanner || "").toLowerCase().includes(q) ||
            String(r.user || "").toLowerCase().includes(q);

          const matchesType =
            activeType === "ALL" || r.type === activeType;

          const matchesOverdue =
            !overdueOnly || r.status !== "OK";

          return matchesSearch && matchesType && matchesOverdue;
        })
        .sort((a,b) => b.hours - a.hours);

      if (!filtered.length) {
        tb.innerHTML = `<tr><td class="empty-row" colspan="5">No taken scanners found.</td></tr>`;
        return;
      }

      filtered.forEach(r => {
        tb.innerHTML += `
          <tr>
            <td>${r.scanner}</td>
            <td>${r.type}</td>
            <td>
              <span
                class="user-link"
                onclick="openUserPanelSafe('${r.user}')"
              >
                ${String(r.user || "").toUpperCase()}
              </span>
              ${r.status !== "OK" ? " ‚ö†Ô∏è" : ""}
            </td>
            <td>${r.hours}h</td>
            <td class="${r.cls}">${r.status}</td>
          </tr>
        `;
      });
    }

    async function loadLogs() {
      const db = firebase.database();
      document.getElementById("logsTable").innerHTML =
        `<tr><td class="empty-row" colspan="5">Loading‚Ä¶</td></tr>`;

      const snap = await db.ref("logs").orderByChild("time").limitToLast(800).once("value");

      logRows = [];
      snap.forEach(child => {
        const v = child.val();
        if (v) logRows.push(v);
      });

      renderLogs();
      loadDailySummary();
    }

    function renderLogs() {
      const q = (elSearch.value || "").toLowerCase().trim();
      const from = document.getElementById("fromDate").value;
      const to = document.getElementById("toDate").value;

      const tb = document.getElementById("logsTable");
      tb.innerHTML = "";

      const newestFirst = logRows.slice().sort((a,b) => {
        const ta = new Date(a?.time || 0).getTime();
        const tb2 = new Date(b?.time || 0).getTime();
        return tb2 - ta;
      });

      const filtered = newestFirst.filter(l => {
        if (!l) return false;

        const d = new Date(l.time || 0);
        if (from && d < new Date(from)) return false;
        if (to && d > new Date(to + "T23:59:59")) return false;

        const device = String(l.device ?? "").toLowerCase();
        const user = String(l.user ?? "").toLowerCase();

        return device.includes(q) || user.includes(q);
      });

      if (!filtered.length) {
        tb.innerHTML = `<tr><td class="empty-row" colspan="5">No logs found.</td></tr>`;
        return;
      }

      filtered.forEach(l => {
        const act = String(l.action || "").toLowerCase();
        tb.innerHTML += `
          <tr>
            <td class="${act === 'take' ? 'take' : 'return'}">${String(l.action || "").toUpperCase()}</td>
            <td>${String(l.device ?? "")}</td>
            <td>${String(l.type ?? "")}</td>
            <td>${String(l.user ?? "").toUpperCase()}</td>
            <td>${new Date(l.time || 0).toLocaleString()}</td>
          </tr>
        `;
      });
    }

    function loadDailySummary() {
      const today = new Date().toDateString();

      let takenToday = 0;
      let returnedToday = 0;

      logRows.forEach(l => {
        if (!l || !l.time) return;

        const logDate = new Date(l.time).toDateString();
        if (logDate !== today) return;

        const action = String(l.action || "").toLowerCase();
        if (action === "take") takenToday++;
        if (action === "return") returnedToday++;
      });

      document.getElementById("sumTaken").innerText = takenToday;
      document.getElementById("sumReturned").innerText = returnedToday;

      document.getElementById("sumOverdue").innerText =
        document.getElementById("statOverdue").innerText;

      document.getElementById("sumMulti").innerText =
        document.getElementById("statMulti").innerText;
    }

    function exportStatusCSV() {
      exportCSV(
        statusRows.map(r => ({
          scanner: r.scanner,
          type: r.type,
          user: r.user,
          taken_since_hours: r.hours,
          status: r.status
        })),
        "scanner_status.csv"
      );
    }

    function exportLogsCSV() {
      exportCSV(
        logRows
          .slice()
          .sort((a,b) => new Date(b?.time || 0) - new Date(a?.time || 0))
          .map(l => ({
            action: String(l.action || "").toUpperCase(),
            scanner: String(l.device ?? ""),
            type: String(l.type ?? ""),
            user: String(l.user ?? ""),
            time: l.time || ""
          })),
        "scanner_logs.csv"
      );
    }

    function exportCSV(rows, name) {
      if (!rows || !rows.length) return alert("No data to export");
      const keys = Object.keys(rows[0]);
      const csv = [keys.join(",")]
        .concat(rows.map(r => keys.map(k => `"${String(r[k] ?? "").replace(/"/g,'""')}"`).join(",")))
        .join("\n");

      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
      a.download = name;
      a.click();
    }

    /* ===== VIEW SWITCHING (FIXED) =====
       Dashboard = everything (cards + daily + status + logs) but NO filters
       Status = only status + filters
       Logs = only logs + filters
       Status-overdue = status + overdue filter auto-enabled
    */
    function showView(view) {
      const filters = document.getElementById("filtersRow");

      // Always hide everything first
      document.getElementById("dashboard")?.classList.add("hidden");
      document.getElementById("dailySummary")?.classList.add("hidden");
      document.getElementById("status")?.classList.add("hidden");
      document.getElementById("logs")?.classList.add("hidden");

      // Reset chip UI
      document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));

      if (view === "dashboard") {
        // ‚úÖ DASHBOARD = HOME
        document.getElementById("dashboard")?.classList.remove("hidden");
        document.getElementById("dailySummary")?.classList.remove("hidden");
        filters?.classList.add("hidden");
      }
      else if (view === "status") {
        document.getElementById("status")?.classList.remove("hidden");
        filters?.classList.remove("hidden");
      }
      else if (view === "logs") {
        document.getElementById("logs")?.classList.remove("hidden");
        filters?.classList.add("hidden");   // ‚úÖ HIDE filters on Logs
      }
    }

    function applyViewFromHash() {
      const hash = window.location.hash.replace("#", "");

      // Reset filter states on each navigation
      overdueOnly = false;
      activeType = "ALL";

      if (hash === "status-overdue") {
        showView("status");
      
        // üîí force overdue-only view
        overdueOnly = true;
        activeType = "ALL";
      
        // update chip UI
        document
          .querySelector('.chip[data-type="OVERDUE"]')
          ?.classList.add("active");
      
        renderStatus();
        return; // ‚¨ÖÔ∏è IMPORTANT: stop fall-through
      } else if (hash === "status") {
        showView("status");
        renderStatus();
      } else if (hash === "logs") {
        showView("logs");
        renderLogs();
      } else {
        showView("dashboard");
      }
    }

    function openUserPanel(user) {
      if (!user) return;
    
      const panel = document.getElementById("userPanel");
      const overlay = document.getElementById("userPanelOverlay");
    
      const nameEl = document.getElementById("userPanelName");
      const summaryEl = document.getElementById("userPanelSummary");
      const listEl = document.getElementById("userPanelScanners");
    
      const totalEl = document.getElementById("panelTotal");
      const longestEl = document.getElementById("panelLongest");
      const statusEl = document.getElementById("panelStatus");
      const recentEl = document.getElementById("panelRecent");
    
      nameEl.innerText = user.toUpperCase();
      listEl.innerHTML = "";
      recentEl.innerHTML = "";
    
      // Only overdue / long scanners (correct behaviour)
      const rows = statusRows.filter(
        r => r.user === user
      );
    
      summaryEl.innerText = `Currently holding ${rows.length} scanner(s)`;

      const headerWarn = document.getElementById("userPanelWarn");

      headerWarn.classList.toggle(
        "hidden",
        !rows.some(r => r.status !== "OK")
      );

      // === EDGE CASE: USER HAS NO ACTIVE SCANNERS ===
      if (rows.length === 0) {
        listEl.innerHTML = "<li class='hint'>No active scanners.</li>";
      
        totalEl.innerText = "0";
        longestEl.innerText = "‚Äì";
        statusEl.innerText = "OK";
      
        panel.classList.remove("hidden");
        overlay.classList.remove("hidden");
        document.body.style.overflow = "hidden";
      
        return; // ‚¨ÖÔ∏è IMPORTANT: stops old data rendering
      }

      let longest = 0;
    
      rows.forEach(r => {
        const li = document.createElement("li");
        li.className = "scanner-card-row";
        if (r.status === "Overdue") {
          li.classList.add("overdue");
        }

        li.innerHTML = `
          <div>
            <strong>Scanner ${r.scanner}</strong>
            <span class="muted">(${r.type})</span>
          </div>
          <div class="right">
            <span class="hours">${r.hours}h</span>
            ${r.status !== "OK" ? '<span class="warn">‚ö†Ô∏è</span>' : ''}
          </div>
        `;
      
        listEl.appendChild(li);
        longest = Math.max(longest, r.hours);
      });

      totalEl.innerText = rows.length;
      longestEl.innerText = longest ? `${longest}h` : "‚Äì";
      statusEl.innerText = rows.some(r => r.status === "Overdue")
        ? "OVERDUE"
        : "OK";
    
      // Recent activity (last 3 actions)
      logRows
        .filter(l => l.user === user)
        .slice(-3)
        .reverse()
        .forEach(l => {
          const li = document.createElement("li");
      
          const time = l.time
            ? new Date(l.time).toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit"
              })
            : "";
      
          li.innerHTML = `
            <span class="activity-text">
              ${l.action} scanner <strong>${l.device}</strong>
            </span>
            <span class="activity-time">${time}</span>
          `;
      
          recentEl.appendChild(li);
        });
    
      panel.classList.remove("hidden");
      overlay.classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }

    async function openUserPanelSafe(user) {
      await loadStatus();   // ensure latest Firebase data
      openUserPanel(user);
    }

    function closeUserPanel() {
      document.getElementById("userPanel").classList.add("hidden");
      document.getElementById("userPanelOverlay").classList.add("hidden");
      document.body.style.overflow = "";
    }


    // Initial loads
    loadStatus();
    loadLogs();

    window.addEventListener("load", applyViewFromHash);
    window.addEventListener("hashchange", applyViewFromHash);
    
    // === SIDEBAR COLLAPSE LOGIC ===
    const sidebar = document.getElementById("sidebar");
    const toggleBtn = document.getElementById("sidebarToggle");

    // === RESTORE DARK MODE STATE ON PAGE LOAD ===
    const savedDarkMode = localStorage.getItem("darkMode");
    
    if (savedDarkMode === "yes") {
      document.body.classList.add("dark");
    }
    const icon = document.getElementById("darkIcon");
    if (icon) {
      icon.textContent = savedDarkMode === "yes" ? "‚òÄÔ∏è" : "üåô";
    }


    // === RESTORE SIDEBAR STATE ON PAGE LOAD ===
    const savedSidebar = localStorage.getItem("sidebarCollapsed");
    
    if (savedSidebar === "yes") {
      sidebar.classList.add("collapsed");
    } else if (savedSidebar === "no") {
      sidebar.classList.remove("collapsed");
    }

    toggleBtn.addEventListener("click", () => {
      const isCollapsed = sidebar.classList.toggle("collapsed");
      localStorage.setItem("sidebarCollapsed", isCollapsed ? "yes" : "no");
    });

    // === KEYBOARD SHORTCUT: CTRL/CMD + B ===
    document.addEventListener("keydown", (e) => {
      const isMac = navigator.platform.toUpperCase().includes("MAC");
      const modifierPressed = isMac ? e.metaKey : e.ctrlKey;
    
      if (modifierPressed && e.key.toLowerCase() === "b") {
        e.preventDefault(); // prevent browser bold action
        sidebar.classList.toggle("collapsed");
      }
    });

    // === ESC KEY CLOSE FOR USER DRILL-DOWN PANEL ===
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        const panel = document.getElementById("userPanel");
        if (panel && !panel.classList.contains("hidden")) {
          closeUserPanel();
        }
      }
    });

    document
      .getElementById("userPanelOverlay")
      .addEventListener("click", closeUserPanel);

    function toggleDarkMode() {
      const isDark = document.body.classList.toggle("dark");
      localStorage.setItem("darkMode", isDark ? "yes" : "no");
    
      const icon = document.getElementById("darkIcon");
      if (icon) {
        icon.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      }
    }

  </script>

    </main>
  </div>
</body>
</html>
