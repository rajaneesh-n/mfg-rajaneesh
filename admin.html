<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Scanner Management – Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f4f6f8;
      color: #222;
    }

    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .header { text-align: center; padding: 20px 10px; }
    .header img { max-width: 120px; margin-bottom: 10px; }
    .header h1 { margin: 0; font-size: 26px; }
    .header p { margin-top: 6px; color: #555; }

    .warning {
      background: #fff3cd;
      color: #856404;
      padding: 12px;
      border-radius: 12px;
      margin: 10px 0 18px;
      display: none;
      font-weight: 700;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin: 18px 0;
    }

    .stat-card {
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }

    .stat-card span { font-size: 13px; color: #666; }
    .stat-card strong { font-size: 30px; font-weight: 800; }

    .section {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
      padding: 16px;
      margin-bottom: 18px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }

    .search-box {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      margin: 10px 0 18px;
    }

    button {
      padding: 8px 12px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      font-weight: 700;
    }

    button.secondary { background: #9ca3af; }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 10px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    thead { background: #f3f4f6; }

    .take { color: #15803d; font-weight: 800; }
    .return { color: #b91c1c; font-weight: 800; }
    .status-long { color: #b45309; font-weight: 800; }

    .empty-row { text-align: center; color: #6b7280; padding: 16px; }
  </style>
</head>

<body>
<div class="header">
  <img src="assets/logo.png">
  <h1>Scanner Management – Admin</h1>
  <p>Dashboard, live status & reports</p>
</div>

<div class="container">

  <div id="warningBanner" class="warning">
    ⚠️ Overdue scanners detected. Immediate action required.
  </div>

  <div class="stats">
    <div class="stat-card"><span>Total Scanners</span><strong id="statTotal">–</strong></div>
    <div class="stat-card"><span>Available</span><strong id="statAvailable">–</strong></div>
    <div class="stat-card"><span>Taken</span><strong id="statTaken">–</strong></div>
    <div class="stat-card"><span>Overdue</span><strong id="statOverdue">–</strong></div>
  </div>

  <input id="searchInput" class="search-box" placeholder="Search by scanner or user">

  <!-- LOGS -->
  <div class="section">
    <div class="section-header">
      <h2>Scanner Logs</h2>
      <button onclick="loadLogs()">Refresh</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Scanner</th>
          <th>Type</th>
          <th>User</th>
          <th>Taken At</th>
          <th>Returned At</th>
          <th>Duration</th>
        </tr>
      </thead>
      <tbody id="logsTable">
        <tr><td colspan="6" class="empty-row">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <div class="footer">
    <button class="secondary" onclick="location.href='index.html'">Back to Home</button>
  </div>

</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="config.js"></script>

<script>
let logRows = [];

async function loadLogs() {
  const snap = await firebase.database().ref("logs").once("value");
  logRows = [];
  snap.forEach(c => logRows.push(c.val()));
  renderLogs();
}

/* ✅ FIXED + PAIRED LOG RENDER */
function renderLogs() {
  const tb = document.getElementById("logsTable");
  tb.innerHTML = "";

  const sorted = logRows
    .slice()
    .sort((a,b) => new Date(a.time) - new Date(b.time));

  const open = {};
  const pairs = [];

  sorted.forEach(l => {
    const key = `${l.type}_${l.device}`;

    if (l.action === "take") {
      open[key] = { ...l, takeTime: l.time, returnTime: null };
    }

    if (l.action === "return" && open[key]) {
      open[key].returnTime = l.time;
      pairs.push(open[key]);
      delete open[key];
    }
  });

  Object.values(open).forEach(p => pairs.push(p));

  if (!pairs.length) {
    tb.innerHTML = `<tr><td colspan="6" class="empty-row">No logs found.</td></tr>`;
    return;
  }

  pairs.reverse().forEach(p => {
    const taken = new Date(p.takeTime);
    const returned = p.returnTime ? new Date(p.returnTime) : null;
    const duration = returned
      ? Math.round((returned - taken) / 60000) + " min"
      : "<span class='status-long'>Still Taken</span>";

    tb.innerHTML += `
      <tr>
        <td>${p.device}</td>
        <td>${p.type}</td>
        <td>${p.user}</td>
        <td>${taken.toLocaleString()}</td>
        <td>${returned ? returned.toLocaleString() : "-"}</td>
        <td>${duration}</td>
      </tr>
    `;
  });
}

loadLogs();
</script>
</body>
</html>
