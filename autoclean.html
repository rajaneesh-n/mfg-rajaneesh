<!DOCTYPE html>
<html>
<head>
  <title>Auto-clean Scanner Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body class="mobile">

  <img src="assets/logo.png" class="logo">
  <h2>Auto-clean Scanner Data</h2>

  <p class="hint">
    Preview and fix missing or duplicate scanners.<br>
    Logs are never modified.
  </p>

  <div class="actions">
    <button onclick="previewFixes()">Preview Issues</button>
    <button class="secondary" onclick="location.href='index.html'">Home</button>
  </div>

  <div id="result" class="list" style="margin-top:16px"></div>

  <div class="actions" id="applySection" style="display:none; margin-top:10px">
    <button onclick="applyFixes()">Apply Fixes</button>
    <button class="secondary" onclick="resetView()">Cancel</button>
  </div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="config.js"></script>

  <script>
    let plannedFixes = [];

    async function previewFixes() {
      plannedFixes = [];
      const result = document.getElementById("result");
      result.innerHTML = "<p class='hint'>Scanning data…</p>";

      const scanners = (await firebase.database().ref("scanners").once("value")).val() || {};
      const taken = (await firebase.database().ref("takenScanners").once("value")).val() || {};

      const types = new Set([
        ...Object.keys(scanners),
        ...Object.keys(taken)
      ]);

      for (const type of types) {
        const avail = scanners[type] || {};
        const inUse = taken[type] || {};

        const allIds = new Set([
          ...Object.keys(avail),
          ...Object.keys(inUse)
        ]);

        for (const id of allIds) {
          const inAvail = avail[id] !== undefined;
          const inTaken = inUse[id] !== undefined;

          if (inAvail && inTaken) {
            plannedFixes.push({
              msg: `Duplicate ${type} ${id} → remove from available`,
              action: () => firebase.database().ref(`scanners/${type}/${id}`).remove()
            });
          }

          if (!inAvail && !inTaken) {
            plannedFixes.push({
              msg: `Missing ${type} ${id} → restore to available`,
              action: () => firebase.database().ref(`scanners/${type}/${id}`).set(true)
            });
          }
        }
      }

      if (plannedFixes.length === 0) {
        result.innerHTML = "<p class='hint'>No issues found. Data is clean ✅</p>";
        return;
      }

      result.innerHTML = plannedFixes
        .map(f => `<div class="row">${f.msg}</div>`)
        .join("");

      document.getElementById("applySection").style.display = "flex";
    }

    async function applyFixes() {
      if (!confirm("Are you sure you want to apply these fixes?")) return;

      for (const fix of plannedFixes) {
        await fix.action();
      }

      document.getElementById("result").innerHTML =
        "<p class='hint'>Fixes applied successfully ✅</p>";
      document.getElementById("applySection").style.display = "none";
      plannedFixes = [];
    }

    function resetView() {
      plannedFixes = [];
      document.getElementById("result").innerHTML = "";
      document.getElementById("applySection").style.display = "none";
    }
  </script>

</body>
</html>
