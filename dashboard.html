<!DOCTYPE html>
<html>
<head>
  <title>Scanner Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body class="mobile">

  <img src="assets/logo.png" class="logo">
  <h2>Scanner Dashboard</h2>
  <div id="alerts" class="list" style="margin-bottom:16px"></div>


  <h3>WMS</h3>
  <div id="wmsList" class="list">
    <p class="hint">Loading...</p>
  </div>

  <h3>MUSHINY</h3>
  <div id="mushinyList" class="list">
    <p class="hint">Loading...</p>
  </div>

  <div class="actions">
    <button class="secondary" onclick="history.back()">Back</button>
  </div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="config.js"></script>

<script>
  const EIGHT_HOURS = 8 * 60 * 60 * 1000;

  function formatDuration(ms) {
    const hours = Math.floor(ms / (60 * 60 * 1000));
    const mins = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
    return `${hours}h ${mins}m`;
  }

  function load(type, elId) {
    const list = document.getElementById(elId);
    list.innerHTML = "<p>Loading...</p>";

    firebase.database()
      .ref("takenScanners/" + type)
      .on("value", snapshot => {
        list.innerHTML = "";

        if (!snapshot.exists()) {
          list.innerHTML = "<p>No scanners taken</p>";
          return;
        }

        snapshot.forEach(child => {
          const data = child.val();
          const div = document.createElement("div");
          div.className = "row";
          div.innerHTML = `
            <strong>${child.key}</strong>
            <span style="float:right; font-size:13px; color:#555">
              ${data.user || "unknown"}
            </span>
          `;
          list.appendChild(div);
        });
      });
  }

  function loadOverdueAlerts() {
    const alertBox = document.getElementById("alerts");
    alertBox.innerHTML = "<p>Checking overdue scanners...</p>";

    firebase.database()
      .ref("takenScanners")
      .once("value")
      .then(snapshot => {
        const now = Date.now();
        const overdue = [];

        snapshot.forEach(typeSnap => {
          const type = typeSnap.key;

          typeSnap.forEach(scannerSnap => {
            const id = scannerSnap.key;
            const data = scannerSnap.val();

            if (!data.time) return;

            const takenTime = new Date(data.time).getTime();
            const diff = now - takenTime;

            if (diff > EIGHT_HOURS) {
              overdue.push({
                type,
                id,
                user: data.user || "unknown",
                duration: formatDuration(diff)
              });
            }
          });
        });

        if (overdue.length === 0) {
          alertBox.innerHTML =
            "<p class='hint'>✅ No overdue scanners</p>";
          return;
        }

        alertBox.innerHTML =
          "<p class='hint'>⚠️ Overdue scanners (8+ hours)</p>" +
          overdue.map(o => `
            <div class="row">
              <strong>${o.type} ${o.id}</strong><br>
              <small>${o.user} • ${o.duration}</small>
            </div>
          `).join("");
      });
  }

  load("WMS", "wmsList");
  load("MUSHINY", "mushinyList");
  loadOverdueAlerts();
</script>


</body>
</html>

