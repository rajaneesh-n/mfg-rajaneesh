<!DOCTYPE html>
<html>
<head>
  <title>Scanner Logs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body class="mobile">

  <!-- LOGO -->
  <img src="assets/logo.png" class="logo">

  <h2>Scanner Logs</h2>

  <!-- CSV EXPORT -->
  <button onclick="downloadCSV()" style="margin-bottom:10px">
    Download CSV
  </button>

  <!-- LOG LIST -->
  <div id="logList" class="list">
    <p class="hint">Loading logs...</p>
  </div>

  <!-- ACTIONS -->
  <div class="actions">
    <button class="secondary" onclick="history.back()">Back</button>
  </div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="config.js"></script>

  <script>
    const list = document.getElementById("logList");

    // LOAD LOGS (latest first)
    firebase.database()
      .ref("logs")
      .limitToLast(100)
      .once("value")
      .then(snapshot => {
        list.innerHTML = "";

        if (!snapshot.exists()) {
          list.innerHTML = "<p>No logs found</p>";
          return;
        }

        const rows = [];
        snapshot.forEach(child => {
          rows.push(child.val());
        });

       rows.reverse().forEach(log => {
  const time = log.time
    ? new Date(log.time).toLocaleString()
    : "Unknown time";

  const action = (log.action || "").toLowerCase();
  const badgeClass = action === "take" ? "badge take" : "badge return";
  const badgeText = action.toUpperCase();

  const div = document.createElement("div");
  div.className = "row";
  div.innerHTML = `
    <span class="${badgeClass}">${badgeText}</span>
    &nbsp; ${log.type || ""} — ${log.device || ""}<br>
    <small>${log.user || "unknown"} • ${time}</small>
  `;
  list.appendChild(div);
});

      })
      .catch(err => {
        list.innerHTML = "<p>Error loading logs</p>";
        console.error(err);
      });

    // DOWNLOAD CSV
    function downloadCSV() {
      firebase.database()
        .ref("logs")
        .once("value")
        .then(snapshot => {
          if (!snapshot.exists()) {
            alert("No logs to export");
            return;
          }

          let csv = "Action,Type,Scanner,User,Time\n";

          snapshot.forEach(child => {
            const l = child.val();
            const time = l.time
              ? new Date(l.time).toLocaleString()
              : "";

            csv += `${l.action || ""},${l.type || ""},${l.device || ""},${l.user || ""},${time}\n`;
          });

          const blob = new Blob([csv], { type: "text/csv" });
          const url = window.URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = "scanner_logs.csv";
          a.click();

          window.URL.revokeObjectURL(url);
        })
        .catch(err => {
          console.error("CSV export failed:", err);
          alert("Error exporting CSV");
        });
    }
  </script>

</body>
</html>
