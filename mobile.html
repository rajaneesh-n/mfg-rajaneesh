<!DOCTYPE html>
<html>
<head>
  <title>Take a Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body class="mobile">

  <!-- LOGO -->
  <img src="assets/logo.png" class="logo">

  <h2>Take a Scanner</h2>

  <!-- TYPE SELECT -->
  <div class="toggle">
    <button id="btnMushiny" onclick="selectType('MUSHINY')">Mushiny</button>
    <button id="btnWms" onclick="selectType('WMS')">WMS</button>
  </div>

  <!-- SCANNER LIST -->
  <div id="scannerList" class="list">
    <p class="hint">Select WMS or Mushiny</p>
  </div>

  <!-- USER NAME -->
  <input type="text" id="userName" placeholder="Enter your name">

  <!-- ACTIONS -->
  <div class="actions">
    <button id="submitBtn" onclick="submitScanner()">Submit</button>
    <button class="secondary" onclick="safeBack()">Back</button>
  </div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="config.js"></script>

  <script>
    let selectedType = null;
    let selectedDevice = null;
    let isSubmitting = false;

    function selectType(type) {
      selectedType = type;
      selectedDevice = null;

      document.getElementById("btnMushiny").classList.remove("active");
      document.getElementById("btnWms").classList.remove("active");

      if (type === "MUSHINY") {
        document.getElementById("btnMushiny").classList.add("active");
      } else {
        document.getElementById("btnWms").classList.add("active");
      }

      loadScanners();
    }

    function loadScanners() {
      const list = document.getElementById("scannerList");
      list.innerHTML = "<p>Loading devices...</p>";

      firebase.database()
        .ref("scanners/" + selectedType)
        .once("value")
        .then(snapshot => {
          list.innerHTML = "";

          if (!snapshot.exists()) {
            list.innerHTML = "<p>No available scanners</p>";
            return;
          }

          snapshot.forEach(child => {
            if (child.val() === true) {
              const div = document.createElement("div");
              div.className = "row";
              div.innerText = child.key;
              div.onclick = () => selectDevice(div, child.key);
              list.appendChild(div);
            }
          });

          if (!list.hasChildNodes()) {
            list.innerHTML = "<p>No available scanners</p>";
          }
        })
        .catch(err => {
          list.innerHTML = "<p>Error loading scanners</p>";
          console.error(err);
        });
    }

    function selectDevice(el, id) {
      document.querySelectorAll(".row").forEach(r =>
        r.classList.remove("selected")
      );
      el.classList.add("selected");
      selectedDevice = id;
    }

    function submitScanner() {
      if (isSubmitting) return;

      const user = document.getElementById("userName").value.trim();
      const submitBtn = document.getElementById("submitBtn");

      if (!selectedType || !selectedDevice || !user) {
        alert("Please select scanner and enter name");
        return;
      }

      isSubmitting = true;
      submitBtn.disabled = true;
      submitBtn.innerText = "Processing...";

      // 1️⃣ Save to takenScanners
      firebase.database()
        .ref("takenScanners/" + selectedType + "/" + selectedDevice)
        .set({
          user: user,
          time: new Date().toISOString()
        })
        .then(() => {
          // 2️⃣ Remove from available scanners
          return firebase.database()
            .ref("scanners/" + selectedType + "/" + selectedDevice)
            .remove();
        })
        .then(() => {
          // 3️⃣ Log action
          return firebase.database().ref("logs").push({
            user: user,
            device: selectedDevice,
            type: selectedType,
            action: "take",
            time: new Date().toISOString()
          });
        })
        .then(() => {
          alert("Scanner taken successfully");
          location.reload();
        })
        .catch(err => {
          console.error("Error taking scanner:", err);
          alert("Something went wrong. Please try again.");
          isSubmitting = false;
          submitBtn.disabled = false;
          submitBtn.innerText = "Submit";
        });
    }

    function safeBack() {
      if (isSubmitting) {
        alert("Please wait, processing in progress");
        return;
      }
      history.back();
    }
  </script>

</body>
</html>
