<!DOCTYPE html>
<html>
<head>
  <title>Take a Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body class="mobile">

  <!-- LOGO -->
  <img src="assets/logo.png" class="logo">

  <h2>Take a Scanner</h2>

  <!-- TYPE SELECT -->
  <div class="toggle">
    <button id="btnMushiny" onclick="selectType('mushiny')">Mushiny</button>
    <button id="btnWms" onclick="selectType('wms')">WMS</button>
  </div>

  <!-- SCANNER LIST -->
  <div id="scannerList" class="list">
    <p class="hint">Select WMS or Mushiny</p>
  </div>

  <!-- USER NAME -->
  <input type="text" id="userName" placeholder="Enter your name">

  <!-- ACTIONS -->
  <div class="actions">
    <button onclick="submit()">Submit</button>
    <button class="secondary" onclick="history.back()">Back</button>
  </div>

  <!-- FIREBASE -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="config.js"></script>

<script>
  let selectedType = null;
  let selectedDevice = null;

  function selectType(type) {
    selectedType = type.toUpperCase(); // WMS / MUSHINY
    selectedDevice = null;

    document.getElementById("btnMushiny").classList.remove("active");
    document.getElementById("btnWms").classList.remove("active");

    if (type === "mushiny") {
      document.getElementById("btnMushiny").classList.add("active");
    } else {
      document.getElementById("btnWms").classList.add("active");
    }

    loadScanners();
  }

  function loadScanners() {
    const list = document.getElementById("scannerList");
    list.innerHTML = "<p>Loading devices...</p>";

    firebase.database()
      .ref("scanners/" + selectedType)
      .once("value")
      .then(snapshot => {
        list.innerHTML = "";

        if (!snapshot.exists()) {
          list.innerHTML = "<p>No available scanners</p>";
          return;
        }

        snapshot.forEach(child => {
          const scannerId = child.key;

          const div = document.createElement("div");
          div.className = "row";
          div.innerText = scannerId;
          div.onclick = () => selectDevice(div, scannerId);

          list.appendChild(div);
        });
      });
  }

  function selectDevice(el, id) {
    document.querySelectorAll(".row").forEach(r =>
      r.classList.remove("selected")
    );
    el.classList.add("selected");
    selectedDevice = id;
  }

  function submit() {
    const user = document.getElementById("userName").value.trim();

    if (!selectedType || !selectedDevice || !user) {
      alert("Please select scanner and enter name");
      return;
    }

    // REMOVE scanner from available list
    firebase.database()
      .ref("scanners/" + selectedType + "/" + selectedDevice)
      .remove();

    // LOG action
    firebase.database().ref("logs").push({
      user,
      device: selectedDevice,
      type: selectedType,
      action: "take",
      time: new Date().toISOString()
    });

    alert("Scanner taken successfully");
    location.reload();
  }
</script>


</body>
</html>
