<!DOCTYPE html>
<html>
<head>
  <title>Return a Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body class="mobile">
  <img src="assets/logo-dark.png" class="logo logo-dark">
  <h2>Return a Scanner</h2>

  <div class="toggle">
    <button id="btnMushiny" onclick="selectType('MUSHINY')">Mushiny</button>
    <button id="btnWms" onclick="selectType('WMS')">WMS</button>
  </div>

  <div class="scroll-area">

    <div id="scannerList" class="list">
      <p class="hint">Select scanner to return</p>
    </div>
  
  </div>

  <!-- STICKY BOTTOM BAR -->
  <div class="bottom-bar">
    <input type="text" id="userName" placeholder="Enter your name">
  
    <div class="actions">
      <button id="returnBtn" onclick="returnScanner()">Return</button>
      <button class="secondary" onclick="safeBack()">Back</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="config.js"></script>

  <script>
    let selectedType = null;
    let selectedDevice = null;
    let isReturning = false;

    function selectType(type) {
      selectedType = type;
      selectedDevice = null;

      document.getElementById("btnMushiny").classList.remove("active");
      document.getElementById("btnWms").classList.remove("active");

      if (type === "MUSHINY") document.getElementById("btnMushiny").classList.add("active");
      else document.getElementById("btnWms").classList.add("active");

      loadTakenScanners();
    }

    function loadTakenScanners() {
      const list = document.getElementById("scannerList");
      list.innerHTML = "<p class='hint'>Loading taken scanners...</p>";

      firebase.database()
        .ref("takenScanners/" + selectedType)
        .once("value")
        .then(snapshot => {
          list.innerHTML = "";

          if (!snapshot.exists()) {
            list.innerHTML = "<p class='hint'>No scanners to return</p>";
            return;
          }

          snapshot.forEach(child => {
            const data = child.val() || {};
            const takenBy = data.user || "unknown";

            const div = document.createElement("div");
            div.className = "row";
            div.innerHTML = `
              <span class="scanner-id">${child.key}</span>
              <span class="taken-by">taken by ${takenBy}</span>
            `;
            div.onclick = () => selectDevice(div, child.key);
            list.appendChild(div);
          });
        })
        .catch(err => {
          list.innerHTML = "<p class='hint'>Error loading scanners</p>";
          console.error(err);
        });
    }

    function selectDevice(el, id) {
      document.querySelectorAll(".row").forEach(r => r.classList.remove("selected"));
      el.classList.add("selected");
      selectedDevice = id;
    
      // Auto-focus name input
      document.getElementById("userName").focus({ preventScroll: true });
    }

    async function returnScanner() {
      if (isReturning) return;

      const user = document.getElementById("userName").value.trim();
      const returnBtn = document.getElementById("returnBtn");

      if (!selectedType || !selectedDevice || !user) {
        alert("Please select scanner and enter name");
        return;
      }

      isReturning = true;
      returnBtn.disabled = true;
      returnBtn.innerText = "Processing...";

      try {
        const db = firebase.database();
        const now = new Date().toISOString();
        const logKey = db.ref("logs").push().key;

        const updates = {};
        updates[`scanners/${selectedType}/${selectedDevice}`] = true;
        updates[`takenScanners/${selectedType}/${selectedDevice}`] = null;
        updates[`logs/${logKey}`] = { action: "return", device: selectedDevice, type: selectedType, user, time: now };

        await db.ref().update(updates);

        showToast(`Scanner ${selectedDevice} returned`);
        setTimeout(() => window.location.href = "index.html", 1200);
      } catch (err) {
        console.error(err);
        alert("Something went wrong");
        isReturning = false;
        returnBtn.disabled = false;
        returnBtn.innerText = "Return";
      }
    }

    function safeBack() {
      if (isReturning) return;
      history.back();
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.remove("hidden");
    
      setTimeout(() => {
        toast.classList.add("hidden");
      }, 1000);
    }

  </script>
  
  <div id="toast" class="toast hidden"></div>

</body>
</html>
